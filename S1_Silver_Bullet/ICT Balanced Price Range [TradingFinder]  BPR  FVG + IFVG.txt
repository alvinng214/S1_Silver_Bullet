// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © TFlab
//@version=5
indicator("ICT Balanced Price Range [TradingFinder]  BPR | FVG + IFVG" ,'ICT BPR TFlab', overlay = true, max_bars_back = 5000, max_boxes_count = 500,max_labels_count = 500, max_lines_count = 500 )

//import Libraries
    //import Order Block Drawing  Library
import TFlab/OrderBlockDrawing_TradingFinder/4 as Drawing
    //import FVG  Library
import TFlab/FVGDetectorLibrary/3 as FVG
    //import Alert Sender Library
import TFlab/AlertSenderLibrary_TradingFinder/1 as Alert
    //import Switching Colors Theme
import TFlab/Dark_Light_Theme_TradingFinder_Switching_Colors_Library/1 as SC
    //import Order Block Overlapping Drawing
import TFlab/OrderBlockOverlappingDrawing/1 as OLB





//Input
	//Global Setting
ShowAllIFVG = input.bool(true, 'Show All FVG & IFVG', group = 'Global Setting')
FVGVaP = input.int(500, 'FVG & IFVG Validity Period (Bar)' , group = 'Logic Parameter' , maxval = 4998 , minval = 10,
 tooltip = 'You can set the validity period of each FVG & IFVG based on the number of candles that have passed since the origin of the Order Block.', group = 'Global Setting')
SCMode = input.string('Light', 'Switching Colors Theme Mode', options = ['Off', 'Light', 'Dark'])
     //Balanced Price Range
showDBPR = input.bool(true, 'show Bullish BPR', group = 'Balanced Price Range',inline = 'DBPR')
showSBPR = input.bool(true, 'show Bearish BPR', group = 'Balanced Price Range',inline = 'SBPR')
DBPRColor = input.color(#16dcff69, '', group = 'Balanced Price Range',inline = 'DBPR')
SBPRColor = input.color(#f1a20f71, '', group = 'Balanced Price Range',inline = 'SBPR')
MLBPR = input.string('Proximal' , 'Mitigation Level BPR', ['Proximal', '50 % OB', 'Distal'], 
 tooltip= 'Using this entry, you can determine which level the price reacts to in a BPR.', group = 'Balanced Price Range')
    //Inversion Fair Value Gap
PShowDeIFVG = input.bool(false, ' Show Bearish IFVG & FVG', group = 'IFVG & FVG',inline = 'IDFVG')
PShowSuIFVG = input.bool(false, ' Show Bullish IFVG & FVG', group = 'IFVG & FVG',inline = 'ISFVG')
OCShowDeIFVG = input.color(#4caf4f27, '', group = 'IFVG & FVG',inline = 'IDFVG')
OCShowSuIFVG = input.color(#ff52522f, '', group = 'IFVG & FVG',inline = 'ISFVG')
MLIFVG = input.string('Proximal' , 'Mitigation Level  IFVG & FVG', ['Proximal', '50 % OB', 'Distal'], 
 tooltip= 'Using this entry, you can determine which level the price reacts to in a  IFVG & FVG.', group = 'IFVG & FVG')

PFVGFilter = input.bool(true, 'FVG Filter ............',  group = 'FVG' , inline = 'FVG Filter')
PFVGFilterType = input.string('Defensive', '', 
 ['Very Aggressive' , 'Aggressive' , 'Defensive' , 'Very Defensive'], group = 'FVG', inline = 'FVG Filter' ,
 tooltip = 'If it is "On", this filter will filter "FVGs" based on the width of the Zone.'  + 
 'From "Very Aggressive" to "Very Defensive" the width of the "FVG" decreases.')

AlertName = input.string('BPR [TradingFinder]', 'Alerts Name', group = 'Alert')
Alert_IFVG = input.string('On' , 'Alert BPR Mitigation' , ['On', 'Off'], 'If you turn on the Alert BPR Mitigation,' +
 'you can receive alerts and notifications after setting the "Alert".' , group = 'Alert')
Frequncy = input.string('Once Per Bar' , 'Message Frequency' , ['All', 'Once Per Bar' , 'Per Bar Close'], 'The triggering frequency. Possible values are: All'+ 
 ' (all function calls trigger the alert), Once Per Bar (the first function call during the bar triggers the alert), ' +  
 ' Per Bar Close (the function call triggers the alert only when it occurs during the last script iteration of the real-time bar,' +  
 ' when it closes). The default is alert.freq_once_per_bar.)', group = 'Alert')
UTC = input.string('UTC' , 'Show Alert time by Time Zone', group = 'Alert')


/////////////////////////////////
///////////////SCT///////////////
/////////////////////////////////

[CShowDeIFVG] = SC.SwitchingColorMode(OCShowDeIFVG , SCMode)
[CShowSuIFVG] = SC.SwitchingColorMode(OCShowSuIFVG , SCMode)
/////////////////////////////////
///////////////FVG///////////////
/////////////////////////////////

[DConditionFVG, DDFVG, DPFVG, BarDFVG, SConditionFVG, SDFVG, SPFVG, BarSFVG] = FVG.FVGDetector(PFVGFilter ? 'On' : 'Off', PFVGFilterType, false, false)


/////////////////////////////////////
///////////////Drawing///////////////
/////////////////////////////////////

    //OUTPUT ==> Alert Trigger
[Alert_DFVG, Alert_SIFVG, ProximalPrice_SIFVG, DistalPrice_SIFVG, Index_SIFVG] = Drawing.OBDrawing('Demand', DConditionFVG,DDFVG, DPFVG, BarDFVG, true, FVGVaP, MLIFVG, MLIFVG, ShowAllIFVG , ShowAllIFVG, PShowDeIFVG, PShowDeIFVG, CShowDeIFVG, CShowSuIFVG)
[Alert_SFVG, Alert_DIFVG, ProximalPrice_DIFVG, DistalPrice_DIFVG, Index_DIFVG] = Drawing.OBDrawing('Supply', SConditionFVG, SDFVG, SPFVG, BarSFVG, true, FVGVaP, MLIFVG, MLIFVG, ShowAllIFVG, ShowAllIFVG, PShowSuIFVG, PShowSuIFVG, CShowSuIFVG, CShowDeIFVG )




[Alert_DBPR] = OLB.OBOverlappingDrawing('Demand', DConditionFVG ,  DistalPrice_DIFVG,ProximalPrice_DIFVG, DDFVG, DPFVG, BarDFVG,true, FVGVaP, MLBPR, true, showDBPR,DBPRColor) 
[Alert_SBPR] = OLB.OBOverlappingDrawing('Supply', SConditionFVG ,  DistalPrice_SIFVG,ProximalPrice_SIFVG, SDFVG, SPFVG, BarSFVG,true, FVGVaP, MLBPR, true, showSBPR,SBPRColor)

///////////////////////////////////
///////////////Alert///////////////
///////////////////////////////////
Alert.AlertSender(Alert_DBPR  , Alert_IFVG, AlertName, 'Bullish', 'Order Block Signal', 'Full' ,Frequncy, UTC, 'Off', 'Long Position in Bullish BPR', open, high, low, close,0,0,0,0,0)
Alert.AlertSender(Alert_SBPR  , Alert_IFVG, AlertName, 'Bearish', 'Order Block Signal', 'Full' ,Frequncy, UTC, 'Off', 'Short Position in Bearish BPR', open, high, low, close,0,0,0,0,0)
